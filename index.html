<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Horror movies</title>
    <script type="text/javascript" src="d3/d3.js"></script>

</head>
<body>
    <div>
        <button id="select">select</button>
        <button id="previous">previous</button>
        <span>1890</span>
        <button id="next">next</button>
        <button id="all">all</button>
    </div>

    <script type="text/javascript">
        var diameter = 70, //max size of the bubbles
            w = 900,
            h = 800;
        var decade = 1890;
        var svg = d3.select("body")
                .append("svg")
                .attr("width", w)
                .attr("height", h)
        d3.csv("data.csv", function(error, data){

            data = data.map(function(d){
                d.year = +d["year"];
                d.year_bucket = +d["year_bucket"];
                return d;
                });
            var tagCount = d3.nest()
                              .key(function(d) { return d.name; })
                              .rollup(function(v) { return v.length; })
                              .entries(data);
            var tagsToDraw = tagCount.filter(function(d) {
                                                return d.value > 5;
                                             });
            var radiusScale = d3.scaleSqrt()
                            .domain([0, d3.max(tagsToDraw, function(d){
                                return d.value})])
                            .range([0,diameter])
            var colorScale    = d3.scaleSequential()
                                .domain([0,d3.max(tagsToDraw, function(d){return d.value})])
                                .interpolator(d3.interpolateCool); //color category

            var simulation = d3.forceSimulation()

                                .force("x", d3.forceX(w/2).strength(0.03))
                                .force("y", d3.forceY(h/2).strength(0.03))

                                .force("collide", d3.forceCollide(function(d){
                                   return radiusScale(d.value)+1;
                                }).strength(0.6))

            var circles = svg.append("g")
                .selectAll("circle")
                .data(tagsToDraw, function(d) {return d.key})
                .enter().append("circle")
                .attr("r", function(d) {
                    return radiusScale(d.value);
                })
                .attr("fill",function(d) {
                    return colorScale(d.value);
                })

            simulation.nodes(tagsToDraw)
                .on("tick", ticked)

            function ticked() {
                circles
                    .attr("cx", function(d){ return d.x})
                    .attr("cy", function(d){ return d.y})
            }

            d3.select("#select")
                .on("click", selectDecade)
            d3.select("#next")
                .on("click", increaseDecade)


            function selectDecade() {
                console.log("select");
                tagCount = d3.nest()
                              .key(function(d) { return d.name; })
                              .rollup(function(v) { return v.length; })
                              .entries(data.filter(function(d) {
                                                return d.year_bucket === decade;
                                             }));
                tagsToDraw = tagCount.filter(function(d) {
                                                return d.value > 0;
                                             });
                //radiusScale.domain([0,d3.max(tagsToDraw,function(d){return d.value})])
                //colorScale.domain([0,d3.max(tagsToDraw, function(d){return d.value})])

                simulation.nodes(tagsToDraw).on("tick",ticked)

                circles = d3.selectAll("circle")
                .data(tagsToDraw, function(d) {return d.key})



                g = circles.enter()
                    .append("g")

                g.append("circle")
                .attr("r", function(d) {
                    return radiusScale(d.value);
                })
                .attr("fill",function(d) {
                    return colorScale(d.value);
                })

                circles.exit()
                .transition()
                .attr("r",0)
                .remove();

                circles.attr("r", function(d) {
                 return radiusScale(d.value);
                })
                .attr("fill",function(d) {
                    return colorScale(d.value);
                })



                simulation.alpha(1).restart();
                debugger;
            };

            function increaseDecade() {
                decade = decade + 10;
            }
         });

    </script>


</body>
</html>