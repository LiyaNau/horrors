<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Horror movies</title>
    <script type="text/javascript" src="d3/d3.js"></script>
    <style type="text/css">
        h1 {
            font-family: "Trebuchet MS", Helvetica, sans-serif;
        }
        p {
            font-family: "Trebuchet MS", Helvetica, sans-serif;
        }
        button {
            background-color: white;
            border:2px solid #4d6ddb;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            border-radius: 4px;
        }
        button:hover {
            background-color: rgba(77, 109, 219, 0.4);
            color: black;
        }
        button:focus {
            outline: none;
        }
        button.pressed {
            background-color: #4d6ddb;
            color: white;
        }
        #tooltip {
            position: absolute;
            width: auto;
            height: auto;
            padding: 6px;
            background-color: white;
            -webkit-border-radius: 4px;
            -moz-border-radius: 4px;
            border-radius: 4px;
            pointer-events: none;
            -webkit-box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.4);
            -moz-box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.4);
            box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.4);
            }
        #tooltip.hidden {
            display: none;
            }
        #tooltip p {
            margin: 0;
            font-family: sans-serif;
            font-size: 14px;
            line-height: 20px;
            }
        .tag {
            pointer-events: none;
        }
        path.line {
            stroke-width: 2;
            fill: none

        }
        #area1 {
            float: left;
        }
        #area2 {
            float: right;
        }
        .legend {
            font-size: 14px;
            font-weight: bold;
            text-anchor: left;
        }

    </style>
</head>
<body>
    <h1>120 years of horror movies</h1>
    <p> Explore keywords for horror movies filmed from 1896 to 2016</p>
    <div >
        <button id="all">all</button>
        <button id="1890" class="decade">1890</button>
        <button id="1900" class="decade">1900</button>
        <button id="1910" class="decade">1910</button>
        <button id="1920" class="decade">1920</button>
        <button id="1930" class="decade">1930</button>
        <button id="1940" class="decade">1940</button>
        <button id="1950" class="decade">1950</button>
        <button id="1960" class="decade">1960</button>
        <button id="1970" class="decade">1970</button>
        <button id="1980" class="decade">1980</button>
        <button id="1990" class="decade">1990</button>
        <button id="2000" class="decade">2000</button>
        <button id="2010" class="decade">2010</button>

    </div>
    <div id="area1"> </div>
    <div id="area2"> </div>
    <div id="tooltip" class="hidden">
        <p><span id="key">key</span></p>
        <p><span id="value">0</span></p>
    </div>
    <script type="text/javascript">
        var diameter = 70, //max size of the bubbles
            w = 700,
            h = 700;
            n_min = 10; //minimal number of mentions for tag

        var decade = 1890;

        var setTags = ["demon", "vampire", "zombies","alien","scientist", "ghost", "monster", "hummer horror", "slasher", "serial killer", "sex", "torture", "witch", "haunted house",
            "suspence","gore", "found footage"];

        var svg = d3.select("#area1")
                .append("svg")
                .attr("id", "bubbleChart")
                .attr("width", w)
                .attr("height", h)

        d3.csv("data.csv", function(error, data){

            data = data.map(function(d){
                d.year = +d["year"];
                d.year_bucket = +d["year_bucket"];
                return d;
                });

            // count tne number of mentions for all tags
            var tagCount = d3.nest()
                              .key(function(d) { return d.name; })
                              .rollup(function(v) { return v.length; })
                              .entries(data);
            // select tags that were mentioned more than n_min times
            var tagsToDraw = tagCount.filter(function(d) {
                                                return d.value > n_min;
                                             });
            var radiusScale = d3.scaleSqrt()
                            .domain([n_min, d3.max(tagsToDraw, function(d){
                                return d.value})])
                            .range([0,diameter])

            var colorScale    = d3.scaleSequential()
                                .domain([0,d3.max(tagsToDraw, function(d){return d.value})])
                                .interpolator(d3.interpolateCool);

            var simulation = d3.forceSimulation()
                                .force("x", d3.forceX().strength(0.03))
                                .force("y", d3.forceY().strength(0.03))
                                .force("collide", d3.forceCollide(function(d){
                                   return radiusScale(d.value)+1;
                                }).strength(0.6))

            var key = function(d) {
                return d.key;
            }

            var tag = function(d) {
                // label to display for bigger bubbles
                if (radiusScale(d.value) > 10) {
                    return d.key;
                }
            }

            var tagUrl = function(d) {
                // creates clipPath url from tag name
                return d.key.split(" ").join("-");
            }

            var g = svg.append("g")
                .attr("transform", "translate(" + w / 2 + "," + h / 2 + ")")

            // creating bubbles
            var circles = g.append("g")
                .attr("id","bubbles")
                .selectAll("circle")
                .data(tagsToDraw, key)
                .enter()
                .append("circle")
                .attr("class","bubble")
                .attr("r", function(d) {
                    return radiusScale(d.value);
                })
                .attr("fill",function(d) {
                    return colorScale(d.value);
                })

            // creating paths
            var paths = g.append("g")
                    .attr("id", "clips")
                    .selectAll("clipPath")
                    .data(tagsToDraw, key)
                    .enter()
                    .append("clipPath")
                        .attr("id", function(d) { return "clip-" + tagUrl(d) })

                paths.append("circle")
                    .attr("class","path")
                    .attr("r", function(d) {return radiusScale(d.value) })

            // creating labels
            var labels = g.append("g")
                    .attr("id", "tags")
                    .selectAll("text")
                    .data(tagsToDraw, key)
                    .enter()

                    .append("text")
                    .attr("class","tag")
                    .attr("clip-path", function(d) {
                        return "url(#clip-" + tagUrl(d) + ")";
                    })
                    .text(tag)
                    .attr("font-family", "sans-serif")
                    .attr("font-size", "11px")
                    .attr("fill", "white")
                    .attr("text-anchor", "middle");

            pathCircles = d3.select("#clips")
                    .selectAll(".path");

            simulation.nodes(tagsToDraw)
                .on("tick", ticked)

            d3.select("#all")
                .on("click", unselect)
            d3.selectAll(".decade")
                .on("click", selectDecade)

            // tooltips
            d3.selectAll(".bubble")
                .on("mouseover",showTooltip)
                .on("mouseout", function() {
                    d3.select("#tooltip").classed("hidden", true);
                })



            function ticked() {

                circles
                    .attr("cx", function(d){ return d.x})
                    .attr("cy", function(d){ return d.y})


                pathCircles
                    .attr("cx", function(d){ return d.x})
                    .attr("cy", function(d){ return d.y})

                labels
                    .attr("x", function(d){ return d.x})
                    .attr("y", function(d){ return d.y})
            }



            function selectDecade() {
                d3.selectAll("button").classed("pressed",false);
                buttonPressed = d3.select(this);
                buttonPressed.classed("pressed",true);
                decade = parseInt(buttonPressed.attr("id"),10);
                // filter data for chosen decade

                n_min = 2;
                tagCount = d3.nest()
                              .key(function(d) { return d.name; })
                              .rollup(function(v) { return v.length; })
                              .entries(data.filter(function(d) {
                                                return d.year_bucket === decade;
                                             }));
                tagsToDraw = tagCount.filter(function(d) {
                                                return d.value > n_min;
                                             });
                // update scales
                radiusScale.domain([n_min,d3.max(tagsToDraw,function(d){return d.value})])
                colorScale.domain([0,d3.max(tagsToDraw, function(d){return d.value})])

                updateChart(tagsToDraw);
            };

            function updateChart(tagsToDraw) {

                // binding  with new data
                circles = circles
                    .data(tagsToDraw, key);
                labels = labels
                    .data(tagsToDraw, key);
                paths = d3.select("#clips")
                    .selectAll("clipPath")
                    .data(tagsToDraw, key)

                // removing unnesessary bubbles
                circles.exit()
                    .transition(2000)
                    .attr("r",0)
                    .remove();

                labels.exit()
                    .remove();

                paths.exit()
                    .remove();

                // adding and updatind bubbles
                circles = circles.enter()
                    .append("circle")
                    .attr("class", "bubble")
                    .merge(circles)
                    .call(function(node) {
                        node.transition(2000)
                        .attr("r", function(d) {
                            return radiusScale(d.value);
                        })
                        .attr("fill",function(d) {
                            return colorScale(d.value);
                        })
                    })

                paths = paths.enter()
                    .append("clipPath")
                    .attr("id", function(d) { return "clip-" + tagUrl(d) })
                    .append("circle")
                    .attr("class","path")
                    .attr("r", function(d) {return radiusScale(d.value) })
                    .merge(paths);


                paths.select("circle")
                    .attr("r", function(d) {return radiusScale(d.value) })

                labels = labels.enter()
                    .append("text")
                    .attr("class","tag")
                    .merge(labels)
                    .attr("clip-path", function(d) {
                        return "url(#clip-" + tagUrl(d) + ")";
                    })
                    .text(tag)
                    .attr("font-family", "sans-serif")
                    .attr("font-size", "11px")
                    .attr("fill", "white")
                    .attr("text-anchor", "middle");

                // tooltips
                d3.selectAll(".bubble")
                .on("mouseover",showTooltip)
                .on("mouseout", function() {
                    d3.select("#tooltip").classed("hidden", true);
                })

                // restarting simulation
                simulation.nodes(tagsToDraw)
                simulation.alpha(1).restart();
                pathCircles = d3.select("#clips")
                    .selectAll(".path");
                //debugger;
            };


            function unselect() {

                d3.selectAll("button").classed("pressed",false);

                buttonPressed = d3.select(this);
                buttonPressed.classed("pressed",true);

                n_min = 10;

                tagCount = d3.nest()
                    .key(function(d) { return d.name; })
                    .rollup(function(v) { return v.length; })
                    .entries(data);

                // select tags that were mentioned more than n_min times
                tagsToDraw = tagCount.filter(function(d) {
                                                return d.value > n_min;
                                             });
                // update scales
                radiusScale.domain([n_min,d3.max(tagsToDraw,function(d){return d.value})])
                colorScale.domain([0,d3.max(tagsToDraw, function(d){return d.value})])
                updateChart(tagsToDraw);
            }

            function showTooltip(d) {

                var x = parseFloat(d3.select(this).attr("cx")) + w / 2 ;
                var y = parseFloat(d3.select(this).attr("cy")) + h / 2;


                var tooltip = d3.select("#tooltip");

                tooltip.style("left", x + "px")
                    .style("top", y + "px")

                tooltip.select("#key")
                    .text(d.key)
                tooltip.select("#value")
                    .text(d.value)

                tooltip.classed("hidden",false);

            }
         // Second chart - multiline

         // preparing data
        toTime = d3.timeParse("%Y");

        tagsByDecade = d3.nest() // summing up number of movies by decade for every tag
            .key(function (d) { return d.name})
            .key(function (d) { return d.year_bucket}).sortKeys(d3.ascending)
            .rollup(function(v) { return v.length})
            .entries(data.filter(function(d) { return (d.year_bucket > 0)}));

        // filter only selected tags
        setTagsByDecade = tagsByDecade.filter(function(d) { return setTags.includes(d.key)})

        setTagsByDecade.forEach(function(d,i) {
            d.active = i < 6 ? true : false; // firs six will be active by default
        })


        var margin = {top: 50, right: 30, bottom: 400, left: 30},
            width = 500 - margin.left - margin.right,
            height =700 - margin.top - margin.bottom;

        // create second chart
        var svg2 = d3.select("#area2")
                .append("svg")
                .attr("id", "lineChart")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)

        var g = svg2.append("g")
                    .attr("transform", "translate(" + margin.left+ "," + margin.top+ ")");

        // creating scales
        var timeScale = d3.scaleTime()
            .range([0, width - 5])
            .domain([ new Date(1900,0,1), new Date(2010,0,1)])

        var yScale = d3.scaleLinear()
            .range([height,0])
            .domain([
                d3.min(tagsByDecade, function(v) {
                    return d3.min(v.values, function(d) {return d.value})
                }),
                d3.max(tagsByDecade, function(v) {
                    return d3.max(v.values, function(d) {return d.value})
                })
            ]);

        var colorOrd = d3.scaleOrdinal(d3.schemeCategory20)

        // add axis
        xAxis = d3.axisBottom(timeScale)
                    .ticks(10);
        g.append("g")
            .attr("class", "axis xAxis")
            .attr("transform", "translate(0," + height+ ")")
            .call(xAxis);


        g.append("g")
            .attr("class", "axis yAxis")
            .call(d3.axisLeft(yScale))
            .append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", margin.left)
            .attr("fill", "#000")
            .text("Number of movies");

        var line = d3.line()
                .curve(d3.curveMonotoneX)
                .x(function (d) {return timeScale(toTime(d.key))})
                .y(function (d) {return yScale(d.value)})

        // adding lines
        lines = g.selectAll(".tagLine")
                    .data(setTagsByDecade)
                    .enter()
                    .append("g")
                    .attr("class","tagline")

        lines.append("path")
            .attr("class", "line")
            .attr("id", function(d) { return "line-" + tagUrl(d)})
            .attr("d", function(d) { return line(d.values)})
            .style("stroke", function(d) {return colorOrd(d.key)})
            .style("opacity", function(d) {
                return d.active ? 1 : 0;
            })

        // adding legend
        var legendWidht = 220,
            legendHeight = 20,
            legendPoint = {x:margin.left, y: (700 - margin.bottom + legendHeight*2)},
            rCircle = 5,
            colorInactive = d3.rgb(200,200,200,1);

        legend = svg2.append("g")
            .selectAll(".legend")
            .data(setTagsByDecade);

        legendEnter = legend.enter().append('g').attr('class', 'legend');

        legendEnter.append("circle")
            .attr("cx", function(d,i) {return legendPoint.x + legendWidht * (i % 2) } )
            .attr("cy", function(d,i) {return legendPoint.y + legendHeight * Math.floor(i/2) - 4})
            .attr("r", rCircle)
            .style("fill", function(d) {
                return d.active ?colorOrd(d.key) : colorInactive;
            })
            .on("click", function(d) {
                var newStatus = d.active ? false : true;
                var newOpacity = newStatus ? 1 : 0;
                d3.select("#line-"+ tagUrl(d))
                    .style("opacity", newOpacity)

                newColor = newStatus ?  colorOrd(d.key): colorInactive;
                d3.select(this).style("fill", newColor)
                d.active = newStatus;
            })
        legendEnter.append("text")
            .attr("x", function(d,i) {return legendPoint.x + legendWidht * (i % 2) + 10} )
            .attr("y", function(d,i) {return legendPoint.y + legendHeight * Math.floor(i/2)} )
            .text(function(d) {return d.key})



         });

    </script>


</body>
</html>