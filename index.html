<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Horror movies</title>
    <script type="text/javascript" src="d3/d3.js"></script>
    <style type="text/css">
        #tooltip {
            position: absolute;
            width: auto;
            height: auto;
            padding: 6px;
            background-color: white;
            -webkit-border-radius: 10px;
            -moz-border-radius: 10px;
            border-radius: 10px;
            pointer-events: none;
            -webkit-box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.4);
            -moz-box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.4);
            box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.4);
            }
        #tooltip.hidden {
            display: yes;
            }
        #tooltip p {
            margin: 0;
            font-family: sans-serif;
            font-size: 14px;
            line-height: 20px;
            }
    </style>
</head>
<body>
    <div>
        <button id="select">select</button>
        <button id="previous">previous</button>
        <span id="decade">1890</span>
        <button id="next">next</button>
        <button id="all">all</button>
    </div>
    <div id="tooltip" class="hidden">
        <p><span id="key">key</span></p>
        <p><span id="value">0</span></p>
    </div>
    <script type="text/javascript">
        var diameter = 70, //max size of the bubbles
            w = 900,
            h = 800;
            n_min = 10; //minimal number of mentions for tag

        var decade = 1890;
        var svg = d3.select("body")
                .append("svg")
                .attr("width", w)
                .attr("height", h)

        d3.csv("data.csv", function(error, data){

            data = data.map(function(d){
                d.year = +d["year"];
                d.year_bucket = +d["year_bucket"];
                return d;
                });

            // count tne number of mentions for all tags
            var tagCount = d3.nest()
                              .key(function(d) { return d.name; })
                              .rollup(function(v) { return v.length; })
                              .entries(data);
            // select tags that were mentioned more than n_min times
            var tagsToDraw = tagCount.filter(function(d) {
                                                return d.value > n_min;
                                             });
            var radiusScale = d3.scaleSqrt()
                            .domain([n_min, d3.max(tagsToDraw, function(d){
                                return d.value})])
                            .range([0,diameter])

            var colorScale    = d3.scaleSequential()
                                .domain([0,d3.max(tagsToDraw, function(d){return d.value})])
                                .interpolator(d3.interpolateCool);

            var simulation = d3.forceSimulation()
                                .force("x", d3.forceX().strength(0.03))
                                .force("y", d3.forceY().strength(0.03))
                                .force("collide", d3.forceCollide(function(d){
                                   return radiusScale(d.value)+1;
                                }).strength(0.6))

            var key = function(d) {
                return d.key;
            }

            var tag = function(d) {
                // label to display for bigger bubbles
                if (radiusScale(d.value) > 10) {
                    return d.key;
                }
            }

            var tagUrl = function(d) {
                // creates clipPath url from tag name
                return d.key.split(" ").join("-");
            }

            var g = svg.append("g")
                .attr("transform", "translate(" + w / 2 + "," + h / 2 + ")")

            // creating bubbles
            var circles = g.append("g")
                .attr("id","bubbles")
                .selectAll("circle")
                .data(tagsToDraw, key)
                .enter()
                .append("circle")
                .attr("class","bubble")
                .attr("r", function(d) {
                    return radiusScale(d.value);
                })
                .attr("fill",function(d) {
                    return colorScale(d.value);
                })

            // creating paths
            var paths = g.append("g")
                    .attr("id", "clips")
                    .selectAll("clipPath")
                    .data(tagsToDraw, key)
                    .enter()
                    .append("clipPath")
                        .attr("id", function(d) { return "clip-" + tagUrl(d) })

                paths.append("circle")
                    .attr("class","path")
                    .attr("r", function(d) {return radiusScale(d.value) })

            // creating labels
            var labels = g.append("g")
                    .attr("id", "tags")
                    .selectAll("text")
                    .data(tagsToDraw, key)
                    .enter()

                    .append("text")
                    .attr("class","tag")
                    .attr("clip-path", function(d) {
                        return "url(#clip-" + tagUrl(d) + ")";
                    })
                    .text(tag)
                    .attr("font-family", "sans-serif")
                    .attr("font-size", "11px")
                    .attr("fill", "white")
                    .attr("text-anchor", "middle");

            pathCircles = d3.select("#clips")
                    .selectAll(".path");

            simulation.nodes(tagsToDraw)
                .on("tick", ticked)

            // buttons action
            d3.select("#select")
                .on("click", selectDecade)
            d3.select("#next")
                .on("click", increaseDecade)
            d3.select("#previous")
                .on("click", decreaseDecade)
            d3.select("#all")
                .on("click", unselect)




            function ticked() {

                circles
                    .attr("cx", function(d){ return d.x})
                    .attr("cy", function(d){ return d.y})


                pathCircles
                    .attr("cx", function(d){ return d.x})
                    .attr("cy", function(d){ return d.y})

                labels
                    .attr("x", function(d){ return d.x})
                    .attr("y", function(d){ return d.y})
            }



            function selectDecade() {
                // filter data for chosen decade

                n_min = 2;
                tagCount = d3.nest()
                              .key(function(d) { return d.name; })
                              .rollup(function(v) { return v.length; })
                              .entries(data.filter(function(d) {
                                                return d.year_bucket === decade;
                                             }));
                tagsToDraw = tagCount.filter(function(d) {
                                                return d.value > n_min;
                                             });
                // update scales
                radiusScale.domain([n_min,d3.max(tagsToDraw,function(d){return d.value})])
                colorScale.domain([0,d3.max(tagsToDraw, function(d){return d.value})])

                updateChart(tagsToDraw);
            };

            function updateChart(tagsToDraw) {

                // binding  with new data
                circles = circles
                    .data(tagsToDraw, key);
                labels = labels
                    .data(tagsToDraw, key);
                paths = d3.select("#clips")
                    .selectAll("clipPath")
                    .data(tagsToDraw, key)
                debugger;

                // removing unnesessary bubbles
                circles.exit()
                    .transition(2000)
                    .attr("r",0)
                    .remove();

                labels.exit()
                    .remove();

                paths.exit()
                    .remove();

                // adding and updatind bubbles
                circles = circles.enter()
                    .append("circle")
                    .attr("class", "bubble")
                    .merge(circles)
                    .call(function(node) {
                        node.transition(2000)
                        .attr("r", function(d) {
                            return radiusScale(d.value);
                        })
                        .attr("fill",function(d) {
                            return colorScale(d.value);
                        })
                    })

                debugger;
                paths = paths.enter()
                    .append("clipPath")
                    .attr("id", function(d) { return "clip-" + tagUrl(d) })
                    .append("circle")
                    .attr("class","path")
                    .attr("r", function(d) {return radiusScale(d.value) })
                    .merge(paths);


                paths.select("circle")
                    .attr("r", function(d) {return radiusScale(d.value) })

                labels = labels.enter()
                    .append("text")
                    .attr("class","tag")
                    .merge(labels)
                    .attr("clip-path", function(d) {
                        return "url(#clip-" + tagUrl(d) + ")";
                    })
                    .text(tag)
                    .attr("font-family", "sans-serif")
                    .attr("font-size", "11px")
                    .attr("fill", "white")
                    .attr("text-anchor", "middle");

                // restarting simulation
                simulation.nodes(tagsToDraw)
                simulation.alpha(1).restart();
                pathCircles = d3.select("#clips")
                    .selectAll(".path");
                //debugger;
            };

            function increaseDecade() {
                decade = decade + 10;
                d3.select("#decade")
                    .text(decade)
            }

            function decreaseDecade() {
                decade = decade -10;
                d3.select("#decade")
                    .text(decade)
            }

            function unselect() {

                n_min = 10;

                tagCount = d3.nest()
                    .key(function(d) { return d.name; })
                    .rollup(function(v) { return v.length; })
                    .entries(data);

                // select tags that were mentioned more than n_min times
                tagsToDraw = tagCount.filter(function(d) {
                                                return d.value > n_min;
                                             });
                // update scales
                radiusScale.domain([n_min,d3.max(tagsToDraw,function(d){return d.value})])
                colorScale.domain([0,d3.max(tagsToDraw, function(d){return d.value})])
                updateChart(tagsToDraw);
            }
         });

    </script>


</body>
</html>